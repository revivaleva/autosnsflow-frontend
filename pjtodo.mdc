# プロジェクトTODO（pjtodo.mdc）

以下はこの作業で検出・処理した項目と、保留中の作業です。

- **完了**: テスト出力の無効化（`__TEST_OUTPUT__` を noop 化）
- **完了**: コメント化された未使用 import の削除/整理
- **完了**: `persistDebugLog` ユーティリティの削除
- **完了**: テスト用定数 `USER_ID` の削除（`DEFAULT_USER_ID` に統一）
- **完了**: 明らかなデバッグ用出力（token-check の一部）を削除
- **完了**: 空の catch を CloudWatch へ出力して再スローする形に置換

---

- **保留 / 未完了**:
  - **Fix prompt construction order in `generateAndAttachContent`**
    - 概要: `prompt` を `policyBlock` 等の宣言より前に参照しているため、順序を正しく組み直す。
  - **Remove remaining `__TEST_OUTPUT__` pushes or replace with noop**
    - 概要: 残存する `__TEST_OUTPUT__` への個別 push を完全削除または noop へ統一する。
  - **Resolve `@/lib/delete-posts-for-account` import**
    - 概要: `deletePostsForAccount` を `packages/shared` に移動し、呼び出し元を shared 参照へ切り替えて解決済み。
  - **Convert `userSucceeded` to `const` where not reassigned**
    - 概要: 再代入が不要な変数を `const` に変更して lint 指摘を解消する。
  - **Audit and remove non-essential debug `console.*` calls**
    - 概要: 本番に不要な info/verbose ログを削除または低いログレベルへ統合する。

- PRUNE TODOs:
  - Implement `pruneOldUsageCountersAll` with BatchWriteItem and updatedAt cutoff. [in progress]
  - Convert per-item DeleteItem deletions to BatchWriteItem for scheduled/posts/replies/logs where safe. [pending]
  - Add AppConfig keys: RETENTION_DAYS_LOGS, PRUNE_LIMIT_POSTS_REPLIES, PRUNE_LIMIT_OTHERS, PRUNE_BATCH_WRITE_SIZE, PRUNE_SCAN_PAGE_SIZE. [pending]
  - Update Discord master message to include per-table deleted/total counts and prune duration. [done]

---

保留にする旨の指示を受けています。次にどのタスクを優先して実行するか指定してください。

---

## 管理画面改修タスク（Admin Users）

- T100: `feature/admin-users` ブランチ作成（staging から） [完了]
- T101: `/api/auth/me` を修正して `isAdmin` を返す（AdminFlag 用） [in_progress]
- T102: `src/pages/api/admin/users.ts` の GET を拡張して `username` と `maxThreadsAccounts` を返す [pending]
- T103: `src/pages/api/admin/users.ts` の PATCH を拡張して `username` と `maxThreadsAccounts` を更新可能にする [pending]
- T104: フロント `src/app/admin/users/page.tsx` に `username` と `maxThreadsAccounts` 列を追加、編集モーダルにフィールド追加 [pending]
- T105: `src/components/AppLayout.jsx` にログイン後 userId 表示とクリックでコピー機能を追加 [pending]
- T106: DynamoDB `UserSettings` のフィールド初期化ロジックを GET 時に実装（既存互換） [pending]
- T107: 小規模な E2E 手順を作成し、staging にマージ後に動作確認を行う [pending]
