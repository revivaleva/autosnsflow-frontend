# プロジェクトTODO（pjtodo.mdc）

以下はこの作業で検出・処理した項目と、保留中の作業です。

- **完了**: テスト出力の無効化（`__TEST_OUTPUT__` を noop 化）
- **完了**: コメント化された未使用 import の削除/整理
- **完了**: `persistDebugLog` ユーティリティの削除
- **完了**: テスト用定数 `USER_ID` の削除（`DEFAULT_USER_ID` に統一）
- **完了**: 明らかなデバッグ用出力（token-check の一部）を削除
- **完了**: 空の catch を CloudWatch へ出力して再スローする形に置換

---

- **保留 / 未完了**:
  - **Fix prompt construction order in `generateAndAttachContent`**
    - 概要: `prompt` を `policyBlock` 等の宣言より前に参照しているため、順序を正しく組み直す。
  - **Remove remaining `__TEST_OUTPUT__` pushes or replace with noop**
    - 概要: 残存する `__TEST_OUTPUT__` への個別 push を完全削除または noop へ統一する。
  - **Resolve `@/lib/delete-posts-for-account` import**
    - 概要: `deletePostsForAccount` を `packages/shared` に移動し、呼び出し元を shared 参照へ切り替えて解決済み。
  - **Convert `userSucceeded` to `const` where not reassigned**
    - 概要: 再代入が不要な変数を `const` に変更して lint 指摘を解消する。
  - **Audit and remove non-essential debug `console.*` calls**
    - 概要: 本番に不要な info/verbose ログを削除または低いログレベルへ統合する。

- PRUNE TODOs:
  - Implement `pruneOldUsageCountersAll` with BatchWriteItem and updatedAt cutoff. [in progress]
  - Convert per-item DeleteItem deletions to BatchWriteItem for scheduled/posts/replies/logs where safe. [pending]
  - Add AppConfig keys: RETENTION_DAYS_LOGS, PRUNE_LIMIT_POSTS_REPLIES, PRUNE_LIMIT_OTHERS, PRUNE_BATCH_WRITE_SIZE, PRUNE_SCAN_PAGE_SIZE. [pending]
  - Update Discord master message to include per-table deleted/total counts and prune duration. [done]

---

保留にする旨の指示を受けています。次にどのタスクを優先して実行するか指定してください。

---

## 管理画面改修タスク（Admin Users）

- T100: `feature/admin-users` ブランチ作成（staging から） [完了]
 - T101: `/api/auth/me` を修正して `isAdmin` を返す（AdminFlag 用） [完了]
 - T102: `src/pages/api/admin/users.ts` の GET を拡張して `username` と `maxThreadsAccounts` を返す [完了]
 - T103: `src/pages/api/admin/users.ts` の PATCH を拡張して `username` と `maxThreadsAccounts` を更新可能にする [完了]
 - T104: フロント `src/app/admin/users/page.tsx` に `username` と `maxThreadsAccounts` 列を追加、編集モーダルにフィールド追加 [完了]
 - T105: `src/components/AppLayout.jsx` にログイン後 userId 表示とクリックでコピー機能を追加 [完了]
 - T106: DynamoDB `UserSettings` のフィールド初期化ロジックを GET 時に実装（既存互換） [完了]
 - T107: 小規模な E2E 手順を作成し、staging にマージ後に動作確認を行う [pending]
 - T108: feature/admin-users → staging の PR を作成する（PR 作成） [pending]
 - T109: staging での動作確認後 main へ反映する（運用承認待ち） [pending]

## App Review / 承認関連

- AR-01: App Review 用ドキュメント作成（`threads_profile_discovery` 権限申請用） [pending]
  - 概要: 申請説明文、スクリーンキャスト（動画）案、必要なプライバシーポリシー/連絡先情報をまとめる。

- AR-02: テスター用手順ドキュメント追加（Graph API Explorer を使ったトークン取得手順） [pending]
  - 概要: テスターアカウントの追加方法、Graph API Explorer でのアクセストークン取得手順を README に追記する。

- AR-03: 申請後の運用手順（承認後の再認可フロー） [pending]
  - 概要: 既存ユーザーへスムーズに新スコープ付与を促すための UI/メールテンプレート案とバッチ再認可トリガーの設計。

- AR-04: 自動再認可トリガー実装（`oauthTokenExpiresAt` を使った再認可案内） [pending]
  - 概要: `oauthTokenExpiresAt` を監視して切迫時にユーザーへ再認可を促す通知（メール or UIバナー）を作成する。

- AR-05: DB とスクリプトの拡張: `fetchPublicProfilePosts(username)` の追加と `accountId` → username 解決フローの実装 [pending]
  - 概要: トークンが無い場合に profile_posts を試すフォールバック実装。ただし実運用前に App Review 承認が必要。

