# プロジェクトTODO（pjtodo.mdc）

以下はこの作業で検出・処理した項目と、保留中の作業です。

- **完了**: テスト出力の無効化（`__TEST_OUTPUT__` を noop 化）
- **完了**: コメント化された未使用 import の削除/整理
- **完了**: `persistDebugLog` ユーティリティの削除
- **完了**: テスト用定数 `USER_ID` の削除（`DEFAULT_USER_ID` に統一）
- **完了**: 明らかなデバッグ用出力（token-check の一部）を削除
- **完了**: 空の catch を CloudWatch へ出力して再スローする形に置換

---

- **保留 / 未完了**:
  - **Fix prompt construction order in `generateAndAttachContent`**
    - 概要: `prompt` を `policyBlock` 等の宣言より前に参照しているため、順序を正しく組み直す。
  - **Remove remaining `__TEST_OUTPUT__` pushes or replace with noop**
    - 概要: 残存する `__TEST_OUTPUT__` への個別 push を完全削除または noop へ統一する。
  - **Resolve `@/lib/delete-posts-for-account` import**
    - 概要: `deletePostsForAccount` を `packages/shared` に移動し、呼び出し元を shared 参照へ切り替えて解決済み。
  - **Convert `userSucceeded` to `const` where not reassigned**
    - 概要: 再代入が不要な変数を `const` に変更して lint 指摘を解消する。
  - **Audit and remove non-essential debug `console.*` calls**
    - 概要: 本番に不要な info/verbose ログを削除または低いログレベルへ統合する。

---

保留にする旨の指示を受けています。次にどのタスクを優先して実行するか指定してください。

- **開発中**: 自動投稿の再試行・候補選択改善
  - 概要: 5分ジョブで引用投稿と通常投稿の取り扱いを改善し、失敗時に詰まらないようにする。現在タスクを分割して実装中。
  - 影響範囲: `lambda/scheduled-autosnsflow/src/handler.ts`, `src/app/scheduled-posts/ScheduledPostsTable.tsx`, `pjspec.mdc` (新規)

- **新規タスク（この作業で作成）**:
  - T001: Add failure metadata to scheduled record and update on post failure (in_progress)
  - T002: Modify runAutoPostForAccount to post one quote and one normal per run (pending)
  - T003: Change selection to prioritize newer quotes over failed older ones (pending)
  - T004: Make posting loop continue on per-candidate errors (do not return) (pending)
  - T005: Skip or deprioritize reservations with postAttempts >= 3 or permanentFailure (pending)
  - T006: Update ScheduledPostsTable to color reservations with failures (pending)
  - T007: Add pjspec documentation for auto-post retry and selection behavior (pending)
  - T008: Mark development status in pjtodo.mdc and list new tasks (pending)
  - T009: Write unit/integration tests for candidate selection and retry logic (pending)
  - T010: Disable editing and immediate posting for quote scheduled posts in UI (completed)
    - 概要: ユーザーが引用投稿の編集・即時投稿を行えないようにフロントで制限を追加。理由は引用元データが確実に渡されないための暫定対応。
    - 影響範囲: `src/app/scheduled-posts/ScheduledPostsTable.tsx`
  - T011: Re-enable quote editing and immediate posting after adding reliable sourcePostText flow (pending)
    - 概要: `sourcePostText` を確実に保存・配信する仕組みを整えた後、引用投稿の編集・即時投稿を再度有効化する（モーダル初期化と送信前バリデーションを追加）。
    - 依存: T003/T001 による DB 保存/レスポンス修正とフロント側バリデーションの実装