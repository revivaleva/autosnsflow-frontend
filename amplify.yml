# /amplify.yml
version: 1
frontend:
  phases:
    preBuild:
      commands:
        # [ADD] 早期終了ガード（差分検出だけを先に実行）
        - nvm install 20 && nvm use 20
        - chmod +x scripts/should-build-frontend.sh || true
        - bash scripts/should-build-frontend.sh
        - node -v
        - npm -v
        - npm ci                              # [KEEP]
        - npm config set fund false           # [ADD] 寄付問い合わせを抑止
        - npm config set audit false          # [ADD] 監査を抑止してインストール短縮
        # 環境変数を明示的に .env.production に書き出す（必要なものだけ）[KEEP]
        - echo "AUTOSNSFLOW_ACCESS_KEY_ID=$AUTOSNSFLOW_ACCESS_KEY_ID" >> .env.production
        - echo "AUTOSNSFLOW_SECRET_ACCESS_KEY=$AUTOSNSFLOW_SECRET_ACCESS_KEY" >> .env.production
        - echo "NEXT_PUBLIC_AWS_REGION=$NEXT_PUBLIC_AWS_REGION" >> .env.production
    build:
      commands:
        # [ADD] フラグがあれば即時成功終了
        - if [ -f /tmp/AMPLIFY_SKIP_BUILD ]; then echo "No frontend changes. Skip build."; exit 0; fi
        - NEXT_TELEMETRY_DISABLED=1 npm run build   # [MOD] Nextのテレメトリ無効化でわずかに短縮
  artifacts:
    baseDirectory: .next
    files:
      - '**/*'
  cache:
    paths:
      - node_modules/**/*
      - .next/cache/**/*      # [ADD] Nextのビルドキャッシュを保持（効果大）
      - ~/.npm/**/*           # [ADD] npmのDLキャッシュを保持（2回目以降が速い）
